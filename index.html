<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel de Gerentes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0b1020; --panel:#111834; --muted:#8ea0c7; --card:#0f1530; --accent:#77e0b5; --accent2:#7cb8ff; --warn:#ffb84d; --danger:#ff6b6b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e9eeff;background:linear-gradient(180deg,#0b1020,#0b0f1c);} 
    .wrap{max-width:1200px;margin:0 auto;padding:20px 16px 56px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin:8px 0 20px}
    .title{font-weight:800;font-size:20px;letter-spacing:.2px}
    .badge{padding:6px 10px;border-radius:999px;background:rgba(124,184,255,.15);color:#beddff;font-size:12px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.035),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);box-shadow:0 10px 30px rgba(0,0,0,.25);border-radius:16px}
    .panel{padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{padding:14px 14px;border-radius:16px;background:linear-gradient(180deg,#0f1530 0%, #0b122a 100%);border:1px solid rgba(255,255,255,.06)}
    .kpi h4{margin:0 0 6px;font-size:12px;color:var(--muted);font-weight:600}
    .kpi .val{font-weight:800;font-size:22px}
    .kpi .sub{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section h3{margin:0 0 10px;font-size:14px;color:#cfe3ff;letter-spacing:.2px}
    .btn{background:#1b2652;border:1px solid rgba(255,255,255,.12);color:#e9eeff;padding:10px 12px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .btn.primary{background:linear-gradient(90deg,#3e8eff,#6de2c8);color:#0b1020;border:none}
    .btn.warn{background:linear-gradient(90deg,#ffb84d,#ff7f50);color:#1a1200;border:none}
    .btn.ghost{background:transparent;border:1px dashed rgba(255,255,255,.2)}
    .select, .input{background:#0e1431;color:#e9eeff;border:1px solid rgba(255,255,255,.12);padding:10px 12px;border-radius:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .progress{height:10px;border-radius:999px;background:#1b244b;overflow:hidden}
    .progress>i{display:block;height:100%;background:linear-gradient(90deg,#7cb8ff,#77e0b5)}
    .table{width:100%;border-collapse:collapse;font-size:12px}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left}
    .pill{padding:2px 8px;border-radius:999px;font-weight:700;font-size:11px}
    .ok{background:rgba(119,224,181,.15);color:#b8fbe2;border:1px solid rgba(119,224,181,.3)}
    .bad{background:rgba(255,107,107,.15);color:#ffd0d0;border:1px solid rgba(255,255,255,.35)}
    .neutral{background:rgba(124,184,255,.15);color:#dcebff;border:1px solid rgba(124,184,255,.3)}

    /* Overlays */
    .overlay{position:fixed;inset:0;background:radial-gradient(1200px 600px at 70% -10%,rgba(76,133,255,.25),transparent 60%),
                                   radial-gradient(1000px 600px at -10% 40%,rgba(119,224,181,.15),transparent 60%),
                                   #0b1020f2;display:flex;align-items:center;justify-content:center;z-index:99}
    .login{width:min(520px,92vw);padding:24px;border-radius:18px}
    .login h2{margin:6px 0 2px}
    .login small{color:var(--muted)}
    .login .field{display:grid;gap:8px;margin:10px 0}
    .login .field label{font-size:12px;color:#cfe3ff}
    .login .hint{font-size:11px;color:var(--muted)}
    .lock{display:inline-flex;width:36px;height:36px;border-radius:12px;align-items:center;justify-content:center;background:rgba(255,255,255,.06);margin-right:8px}
    .notice{font-size:12px;color:var(--muted)}
    .err{color:#ffd0d0}

    /* Loader (bolinha) */
    #loadingOverlay{display:none}
    .loader-wrap{display:flex;flex-direction:column;align-items:center;gap:10px;background:#0b1020e6;padding:20px 24px;border-radius:16px;border:1px solid rgba(255,255,255,.08)}
    .spinner{width:34px;height:34px;border-radius:50%;border:3px solid rgba(255,255,255,.2);border-top-color:#7cb8ff;animation:spin 0.9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Lista com rolagem invis√≠vel (Cancelamentos) */
    .canc-list{max-height:220px;overflow:auto;padding-right:6px;scrollbar-width:none;-ms-overflow-style:none}
    .canc-list::-webkit-scrollbar{width:0;height:0}
    
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
    }

    /* ===== CELEBRA√á√ÉO (modal + fogos) ===== */
    #celeOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:120}
    #celeOverlay.show{display:flex}
    #celeOverlay .back{position:absolute;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(2px)}
    #celeCanvas{position:absolute;inset:0;display:block}
    .cele-card{
      position:relative; z-index:2; text-align:center; padding:18px 20px; border-radius:16px;
      background:linear-gradient(180deg,rgba(255,255,255,.1),rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.2); box-shadow:0 10px 30px rgba(0,0,0,.35); max-width:min(560px,92vw)
    }
    .cele-title{font-weight:900;font-size:22px;letter-spacing:.3px;margin:0 0 8px}
    .cele-sub{color:#cfe3ff;margin:0 0 12px}
    .cele-btn{background:linear-gradient(90deg,#3e8eff,#6de2c8);color:#0b1020;border:none;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .cele-emoji{font-size:20px;margin-left:6px}
  </style>
</head>
<body>
  <!-- LOGIN POR EMPRESA -->
  <div class="overlay" id="loginOverlay">
    <div class="card login">
      <div class="row"><span class="lock">üîí</span><div>
        <div class="badge">Acesso restrito por empresa</div>
        <h2>Entrar no Painel</h2>
        <small>Selecione a empresa e digite a senha correspondente.</small>
      </div></div>

      <div class="field">
        <label>Empresa</label>
        <select class="select" id="empresaSelect">
          <option value="">Selecione‚Ä¶</option>
          <option>MERCATTO DEL√çCIA</option>
          <option>DEL√çCIA GOURMET</option>
          <option>VILLA GOURMET</option>
          <option>M. KIDS</option>
          <option>PADARIA DEL√çCIA</option>
        </select>
      </div>
      <div class="field">
        <label>Senha</label>
        <input id="senhaInput" class="input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="hint">Dica: edite o mapa de senhas em <code>COMPANY_PASSWORDS</code>.</div>
        <div class="hint err" id="loginErr" style="display:none">Empresa ou senha inv√°lidos.</div>
      </div>
      <div class="row" style="justify-content:space-between;margin-top:6px">
        <button class="btn ghost" id="verEmpresas">Ver empresas habilitadas</button>
        <button class="btn primary" id="entrarBtn">Entrar</button>
      </div>
      <p class="notice" style="margin-top:10px">‚ö†Ô∏è Este login √© exclusivo para uso interno, √© pro√≠bido o acesso de terceiros.</p>
    </div>
  </div>

  <!-- Overlay de Carregando -->
  <div class="overlay" id="loadingOverlay">
    <div class="loader-wrap">
      <div class="spinner"></div>
      <div class="badge">Carregando dados‚Ä¶</div>
    </div>
  </div>

  <!-- Overlay de CELEBRA√á√ÉO -->
  <div id="celeOverlay" aria-hidden="true">
    <div class="back" id="celeBack"></div>
    <canvas id="celeCanvas"></canvas>
    <div class="cele-card" role="dialog" aria-modal="true" aria-labelledby="celeTitle">
      <h3 id="celeTitle" class="cele-title">Meta atingida! üéâ</h3>
      <p id="celeSub" class="cele-sub">Parab√©ns, voc√™ bateu 100% da meta deste per√≠odo.</p>
      <button id="celeClose" class="cele-btn">Fechar <span class="cele-emoji">üöÄ</span></button>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div>
        <div class="title">üìä Painel de Gest√£o</div>
        <div class="badge" id="empresaBadge">‚Äî</div>
      </div>
      <div class="toolbar">
        <input type="date" class="input" id="dtInicio" />
        <input type="date" class="input" id="dtFim" />
        <button class="btn" id="btnHoje">Hoje</button>
        <button class="btn primary" id="btnAtualizar">Atualizar</button>
        <button class="btn warn" id="btnSair">Sair</button>
      </div>
    </header>

    <!-- KPIs -->
    <section class="kpis">
      <div class="kpi"><h4>Meta Mensal</h4><div class="val" id="kpiMeta">‚Äî</div><div class="sub" id="kpiMetaSub">‚Äî</div></div>
      <div class="kpi"><h4>Vendas do Dia</h4><div class="val" id="kpiDia">‚Äî</div><div class="sub" id="kpiDiaSub">‚Äî</div></div>
      <div class="kpi"><h4>Cancelamentos</h4><div class="val" id="kpiCanc">‚Äî</div><div class="sub" id="kpiCancSub">‚Äî</div></div>
      <div class="kpi"><h4>Travas de Compras</h4><div class="val" id="kpiTrava">‚Äî</div><div class="sub" id="kpiTravaSub">‚Äî</div></div>
    </section>

    <div class="grid" style="margin-top:14px">
      <section class="card panel section">
        <h3>1) Metas de Vendas</h3>
        <canvas id="chartMetas" height="140"></canvas>
      </section>

      <section class="card panel section">
        <h3>2) Vendas do Dia</h3>
        <canvas id="chartDia" height="140"></canvas>
      </section>

      <section class="card panel section">
        <h3>3) Cancelamentos</h3>
        <div class="row" style="gap:16px;align-items:flex-start">
          <div style="flex:1">
            <canvas id="chartCanc" height="160"></canvas>
          </div>
          <div style="flex:1">
            <!-- LISTA COM ROLAGEM INVIS√çVEL -->
            <div class="canc-list">
              <table class="table" id="tblCanc">
                <thead><tr><th>Item</th><th>Total</th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <section class="card panel section">
        <h3>4) Travas de Compras</h3>
        <div id="travasWrap" class="row" style="flex-direction:column;align-items:stretch;gap:12px"></div>
      </section>
    </div>

    <div class="row" style="margin-top:16px;justify-content:flex-end">
      <button class="btn" id="btnCSV">Exportar CSV</button>
      <button class="btn" id="btnPDF">Exportar PDF</button>
    </div>
  </div>

<script>
/********************** CONFIG *************************/
const COMPANY_PASSWORDS = {
  "MERCATTO DEL√çCIA": "mercatto#2025",
  "DEL√çCIA GOURMET": "delicia#2025",
  "VILLA GOURMET": "villa#2025",
  "M. KIDS": "mkids#2025",
  "PADARIA DEL√çCIA": "padaria#2025"
};

const ENDPOINTS = {
  METAS: "https://script.google.com/macros/s/AKfycbx3xmZeDxBLzCtZx7HnlIlJlhtTVqVNXugToptqxv1alhN2xSJpw-7TJrjzsL7DgtBg/exec",
  VENDAS_DIA: "https://script.google.com/macros/s/AKfycbzP7mKm0n0B1mBW5sERPZT4jnGxG2dKTcnN17W_2F2_i0Po0szL8GZxAb7RNPCBmJSS/exec",
  CANCELAMENTOS: "https://script.google.com/macros/s/AKfycbycmmXqkrASn5a2jpvTFSJDNVMrqPMAcrJivZIEnZhwTtJSN4J76qgtB1qIoNHw-T9j/exec",
  /* mesmo link do painel de travas (usa parametro periodo=YYYY-MM) */
  TRAVAS: "https://script.google.com/macros/s/AKfycbyDGQ-srD7OFMORoRo7ZH2BDaz_tJVVlsqjdlLTI0OpkEKv3tQ5Ny02h3blo7GKjsFEIw/exec"
};

const CURRENCY = new Intl.NumberFormat('pt-BR', { style:'currency', currency:'BRL' });

/* paleta para o gr√°fico de pizza (cancelamentos) */
const PALETTE = ['#7cb8ff','#77e0b5','#ffb84d','#ff6b6b','#9b8cff','#6de2c8','#ffd166','#f78da7','#d4a5a5','#a8e6cf','#ffd3b6','#cdb4db'];

/* planos v√°lidos para somar "Fornecedores" em travas (fallback) */
const PLANOS_VALIDOS = new Set([
  'Fornecedores em geral (insumos)','Bebidas (adegas)','Cerveja/Long','Refrigerantes/√°gua/suco',
  'Frios/congelados','Doces e chocolates','Latic√≠nios','Gelatto','Hortali√ßas (Padaria)','Hortifruti',
  'Processados/assados (Panifica√ß√£o)','Salm√£o','Pescados (peixaria)','Chopp Brahma',
  'A√ßougues','Aves','Mercados Locais LEM','Mercado (Materiais N√£o Consumo)'
]);

/********************** ESTADO *************************/
const state = { empresa:null, periodo:{inicio:null,fim:null}, data:{ metas:null, vendasDia:null, cancelamentos:null, travas:null } };
let _vendasPrimeiroCarregamento = true; // √∫ltimos 7 dias (vendas)
let _cancPrimeiroCarregamento   = true; // √∫ltimos 7 dias (cancelamentos)

/********************** UTIL *************************/
const $ = (q)=>document.querySelector(q);
function setBadgeEmpresa(name){ $('#empresaBadge').textContent = name || '‚Äî' }
function todayISO(){ return new Date().toISOString().slice(0,10) }
function addDaysISO(iso, delta){
  const d = new Date(iso+'T00:00:00'); d.setDate(d.getDate()+delta);
  const y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), dd=('0'+d.getDate()).slice(-2);
  return `${y}-${m}-${dd}`;
}
function buildURL(base, params){ const u = new URL(base); Object.entries(params||{}).forEach(([k,v])=>{ if(v!==undefined && v!==null && v!=='') u.searchParams.set(k,v) }); return u.toString(); }
async function safeFetch(url){ const res = await fetch(url); if(!res.ok) throw new Error('HTTP '+res.status); return res.json(); }
function pct(num, den){ return den>0 ? (num/den)*100 : 0 }
function clamp(n, min, max){ return Math.max(min, Math.min(max, n)) }
function barHTML(label, value, max){
  const p = clamp(pct(value,max),0,200).toFixed(1);
  const theme = p>100? 'background:linear-gradient(90deg,var(--danger),#ff9a9a)' : 'background:linear-gradient(90deg,#7cb8ff,#77e0b5)';
  return `<div class="row" style="justify-content:space-between"><div>${label}</div><div><b>${CURRENCY.format(value)}</b> / ${CURRENCY.format(max)} ‚Äî <span class="pill ${p>100?'bad':'ok'}">${p}%</span></div></div>
          <div class="progress"><i style="width:${Math.min(p,100)}%;${theme}"></i></div>`;
}
function toCSV(rows){ return rows.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n') }
function parseBR(n){
  if(typeof n==='number') return n;
  if(n==null || n==='') return 0;
  return Number(String(n).replace(/\s|R\$/g,'').replace(/\./g,'').replace(',', '.')) || 0;
}
function fmtBR(iso){
  if(!iso) return '';
  const d = new Date(iso+'T00:00:00');
  if (isNaN(d)) return iso;
  return d.toLocaleDateString('pt-BR');
}

/* === Helpers de calend√°rio para proje√ß√£o (PREVIS√ÉO) === */
function _dayOfMonth(iso){ const d = new Date(iso+'T00:00:00'); return isNaN(d)? 0 : d.getDate(); }
function _daysInMonth(iso){ const d = new Date(iso+'T00:00:00'); if(isNaN(d)) return 0; return new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); }
function calcularPrevisaoMensal(periodoISO, realizadoAteHoje){
  const dia = _dayOfMonth(periodoISO), diasMes = _daysInMonth(periodoISO);
  if(!dia || !diasMes) return 0;
  return (realizadoAteHoje / dia) * diasMes;
}

/********************** LOGIN *************************/
const loginOverlay = $('#loginOverlay');
const loadingOverlay = $('#loadingOverlay');
$('#entrarBtn').addEventListener('click', ()=>doLogin());
/* ENTER para logar */
$('#senhaInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
$('#empresaSelect').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doLogin(); });
document.addEventListener('keydown', (e)=>{ 
  if (loginOverlay.style.display !== 'none' && e.key === 'Enter') doLogin(); 
});
/* demais bot√µes */
$('#verEmpresas').addEventListener('click', ()=> alert('Empresas habilitadas: '+Object.keys(COMPANY_PASSWORDS).join(', ')) );
$('#btnSair').addEventListener('click', ()=>{ loginOverlay.style.display='flex'; state.empresa=null; setBadgeEmpresa('‚Äî'); });

async function doLogin(){
  const emp = $('#empresaSelect').value.trim();
  const pw = $('#senhaInput').value;
  const ok = COMPANY_PASSWORDS[emp] && COMPANY_PASSWORDS[emp]===pw;
  if(!ok){ $('#loginErr').style.display='block'; return }
  $('#loginErr').style.display='none';
  state.empresa = emp; setBadgeEmpresa(emp);
  loginOverlay.style.display='none';
  $('#dtInicio').value = todayISO(); $('#dtFim').value = todayISO();

  loadingOverlay.style.display='flex';
  try { await refreshAll(); } 
  finally { loadingOverlay.style.display='none'; }
}

/********************** INTERA√á√ïES *************************/
$('#btnHoje').addEventListener('click', async ()=>{
  $('#dtInicio').value=todayISO(); $('#dtFim').value=todayISO();
  loadingOverlay.style.display='flex';
  try { await refreshAll(); } finally { loadingOverlay.style.display='none'; }
});

$('#btnAtualizar').addEventListener('click', async ()=>{
  loadingOverlay.style.display='flex';
  try { await refreshAll(); } finally { loadingOverlay.style.display='none'; }
});

$('#btnCSV').addEventListener('click', ()=>{
  const rows = [
    ['Empresa', state.empresa], ['In√≠cio', state.periodo.inicio], ['Fim', state.periodo.fim], [],
    ['KPI','Valor','Obs'],
    ['Meta Mensal', $('#kpiMeta').textContent, $('#kpiMetaSub').textContent],
    ['Vendas do Dia', $('#kpiDia').textContent, $('#kpiDiaSub').textContent],
    ['Cancelamentos', $('#kpiCanc').textContent, $('#kpiCancSub').textContent],
    ['Travas de Compras', $('#kpiTrava').textContent, $('#kpiTravaSub').textContent],
  ];
  const blob = new Blob([toCSV(rows)], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a');
  a.href = URL.createObjectURL(blob); a.download = `painel_${(state.empresa||'empresa').replaceAll(' ','_')}.csv`; a.click();
});
$('#btnPDF').addEventListener('click', ()=>{ window.print(); });

/********************** PARSE ‚Äì METAS *************************/
function normalizeMetasPayload(raw){
  const arr = Array.isArray(raw) ? raw : (Array.isArray(raw?.data) ? raw.data : []);
  return arr.map(r => ({
    Data: r?.Data || r?.data || '',
    Empresa: (r?.Empresa || r?.empresa || '').trim(),
    Previsto: parseBR(r?.Previsto ?? r?.previsto),
    Realizado: parseBR(r?.Realizado ?? r?.realizado),
  }));
}
function pickUltimaMeta(records, empresa){
  const validos = records.filter(r =>
    r.Empresa === empresa &&
    r.Data && r.Data !== '1969-12-31' &&
    (r.Previsto !== '' && r.Realizado !== '')
  );
  if(!validos.length) return { metaMensal:0, realizado:0, periodo:'-' };
  const ultimaData = validos.reduce((m,r)=> r.Data>m? r.Data : m, validos[0].Data);
  const rec = validos.find(r=>r.Data===ultimaData) || validos[validos.length-1];
  return { metaMensal: parseBR(rec.Previsto), realizado: parseBR(rec.Realizado), periodo: rec.Data };
}

/********************** BUSCA DE DADOS *************************/
async function refreshAll(){
  if(!state.empresa) return;
  state.periodo.inicio = $('#dtInicio').value; state.periodo.fim = $('#dtFim').value;

  // METAS
  let metasPacked = null;
  try{
    const urlUltima = buildURL(ENDPOINTS.METAS, { empresa: state.empresa, ultima: 'true' });
    metasPacked = await safeFetch(urlUltima);
  }catch(e){ metasPacked = null; }
  if(!metasPacked || (Array.isArray(metasPacked) && metasPacked.length===0) || (Array.isArray(metasPacked?.data) && metasPacked.data.length===0)){
    try{ metasPacked = await safeFetch(ENDPOINTS.METAS); }catch(e){ metasPacked = []; }
  }
  const metasArr = normalizeMetasPayload(metasPacked);
  const metas = pickUltimaMeta(metasArr, state.empresa);

  // VENDAS POR DIA (gr√°fico de dias)
  let vendasDia = null;
  if (ENDPOINTS.VENDAS_DIA) {
    try {
      const serie = await safeFetch(buildURL(ENDPOINTS.VENDAS_DIA, { empresa: state.empresa }));
      const arr = Array.isArray(serie) ? serie : (Array.isArray(serie?.data) ? serie.data : []);
      const norm = arr.map(r => ({ 
        dataISO: (r?.data || r?.Data || '').slice(0,10), 
        total: Number(r?.total ?? r?.Total ?? r?.valor ?? 0)
      })).filter(x => x.dataISO);
      norm.sort((a,b)=> a.dataISO.localeCompare(b.dataISO));

      let janela = [];
      if (_vendasPrimeiroCarregamento) {
        janela = norm.slice(-7); // √∫ltimos 7 dias
        _vendasPrimeiroCarregamento = false;
      } else {
        const ini = state.periodo.inicio || '0000-01-01';
        const fi  = state.periodo.fim    || '9999-12-31';
        janela = norm.filter(x => x.dataISO >= ini && x.dataISO <= fi);
      }

      const labels = janela.map(x => fmtBR(x.dataISO));
      const valores = janela.map(x => x.total);
      const inicio = janela[0]?.dataISO || '';
      const fim    = janela[janela.length-1]?.dataISO || inicio;

      vendasDia = {
        inicio, fim,
        totalHoje: valores.reduce((a,b)=>a+b,0),
        labels, valores
      };
    } catch (e) {
      vendasDia = null;
      _vendasPrimeiroCarregamento = false;
    }
  }

  // CANCELAMENTOS ‚Äî √∫ltimos 7 dias no 1¬∫ load, depois filtros
  let cancelamentos = null;
  if (ENDPOINTS.CANCELAMENTOS){
    try{
      if (_cancPrimeiroCarregamento){
        const fim = todayISO();
        const inicio = addDaysISO(fim, -6); // janela de 7 dias
        cancelamentos = await safeFetch(buildURL(ENDPOINTS.CANCELAMENTOS, { empresa: state.empresa, inicio, fim }));
        cancelamentos.inicio = inicio; cancelamentos.fim = fim; // para o subt√≠tulo
        _cancPrimeiroCarregamento = false;
      } else {
        cancelamentos = await safeFetch(buildURL(ENDPOINTS.CANCELAMENTOS, { empresa: state.empresa, inicio: state.periodo.inicio, fim: state.periodo.fim }));
        cancelamentos.inicio = state.periodo.inicio; cancelamentos.fim = state.periodo.fim;
      }
    }catch(e){ cancelamentos = null; _cancPrimeiroCarregamento=false; }
  }

  // TRAVAS ‚Äî usa o MESMO endpoint do painel de travas (periodo=YYYY-MM)
  const periodoMes = (state.periodo.fim || todayISO()).slice(0,7);
  const travas = ENDPOINTS.TRAVAS
    ? await safeFetch(buildURL(ENDPOINTS.TRAVAS, { empresa: state.empresa, periodo: periodoMes })).catch(()=>null)
    : null;

  state.data = { metas, vendasDia, cancelamentos, travas };

  renderMetas(metas);
  renderVendasDia(vendasDia);
  renderCancelamentos(cancelamentos);
  renderTravas(travas);
}

/********************** CELEBRA√á√ÉO: modal + fogos **********************/
const cele = {
  el: $('#celeOverlay'),
  back: $('#celeBack'),
  closeBtn: $('#celeClose'),
  title: $('#celeTitle'),
  sub: $('#celeSub'),
  cvs: document.getElementById('celeCanvas'),
  ctx: null,
  W: 0, H: 0,
  running: false,
  raf: 0,
  rockets: [],
  particles: [],
  start(titulo, subtitulo){
    if(this.running) return;
    this.title.textContent = titulo || 'Meta atingida! üéâ';
    this.sub.textContent = subtitulo || 'Parab√©ns, voc√™ bateu 100% da meta deste per√≠odo.';
    this.el.classList.add('show');
    this.ctx = this.cvs.getContext('2d');
    const resize = ()=>{
      this.W = this.cvs.width = window.innerWidth;
      this.H = this.cvs.height = window.innerHeight;
    };
    this._resize = resize;
    resize();
    window.addEventListener('resize', resize);
    this.running = true;
    this._spawnTimer = 0;
    this.loop();
  },
  stop(){
    if(!this.running) return;
    this.running = false;
    cancelAnimationFrame(this.raf);
    window.removeEventListener('resize', this._resize);
    this.el.classList.remove('show');
    this.rockets.length = 0; this.particles.length = 0;
    this.ctx && this.ctx.clearRect(0,0,this.W,this.H);
  },
  loop(){
    if(!this.running) return;
    const now = performance.now();
    const ctx = this.ctx;

    // fundo transl√∫cido para "rastro"
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.fillRect(0,0,this.W,this.H);

    // lan√ßar foguetes periodicamente
    if(!this._last) this._last = now;
    const dt = (now - this._last) / 1000;
    this._last = now;
    this._spawnTimer += dt;
    if(this._spawnTimer > 0.4){
      this._spawnTimer = 0;
      // lan√ßa 1‚Äì3 foguetes
      const n = 1 + Math.floor(Math.random()*3);
      for(let i=0;i<n;i++){
        this.launchRocket();
      }
    }

    // atualizar foguetes
    for(let i=this.rockets.length-1;i>=0;i--){
      const r = this.rockets[i];
      r.vy += 20 * dt; // gravidade leve
      r.x += r.vx * dt;
      r.y += r.vy * dt;
      r.life -= dt;
      // desenha
      ctx.beginPath();
      ctx.arc(r.x, r.y, 2, 0, Math.PI*2);
      ctx.fillStyle = r.color;
      ctx.fill();
      // explode
      if(r.life <= 0 || r.vy > 0){
        this.explode(r.x, r.y, r.color);
        this.rockets.splice(i,1);
      }
    }

    // atualizar part√≠culas
    for(let i=this.particles.length-1;i>=0;i--){
      const p = this.particles[i];
      p.vy += 80 * dt;
      p.vx *= 0.98; p.vy *= 0.98;
      p.x += p.vx * dt;
      p.y += p.vy * dt;
      p.alpha -= p.fade * dt;
      // desenha
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
      ctx.fillStyle = `rgba(${p.r},${p.g},${p.b},${Math.max(p.alpha,0)})`;
      ctx.fill();

      if(p.alpha <= 0 || p.y > this.H+20) this.particles.splice(i,1);
    }

    this.raf = requestAnimationFrame(()=>this.loop());
  },
  launchRocket(){
    const x = Math.random() * this.W * 0.8 + this.W*0.1;
    const y = this.H + 10;
    const vx = (Math.random()-0.5) * 60;
    const vy = - (180 + Math.random()*140);
    const hue = Math.floor(Math.random()*360);
    const color = `hsl(${hue}, 80%, 60%)`;
    this.rockets.push({x,y,vx,vy,life:0.8+Math.random()*0.6,color});
  },
  explode(x,y,color){
    // converte cor hsl para rgb aproximado desenhando uma vez
    const tmp = document.createElement('canvas').getContext('2d');
    tmp.fillStyle = color; tmp.fillRect(0,0,1,1);
    const [r,g,b] = tmp.getImageData(0,0,1,1).data;

    const count = 60 + Math.floor(Math.random()*40);
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2;
      const spd = 60 + Math.random()*220;
      this.particles.push({
        x, y,
        vx: Math.cos(ang)*spd,
        vy: Math.sin(ang)*spd,
        r, g, b,
        size: 1.5 + Math.random()*1.5,
        alpha: 1,
        fade: 0.6 + Math.random()*0.8
      });
    }
  }
};

// fechar modal (bot√£o, fundo, ESC)
document.getElementById('celeClose').addEventListener('click', ()=> cele.stop());
document.getElementById('celeBack').addEventListener('click', ()=> cele.stop());
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') cele.stop(); });

function maybeCelebrate(pReal, empresa, periodo, meta, realizado){
  if(!(pReal>=100) || !empresa || !periodo) return;
  const ym = String(periodo).slice(0,7) || 'mes';
  const key = `cele:${empresa}|${ym}`;
  if(sessionStorage.getItem(key)) return; // evita repetir no mesmo m√™s/empresa

  const titulo = 'Meta atingida! üéâ';
  const subt = `Realizado de ${CURRENCY.format(realizado)} sobre meta de ${CURRENCY.format(meta)} (${pReal.toFixed(1)}%). Excelente!`;
  cele.start(titulo, subt);
  sessionStorage.setItem(key,'1');

  // encerra sozinho ap√≥s 10s caso o usu√°rio n√£o feche
  setTimeout(()=>cele.stop(), 10000);
}

/********************** RENDER ‚Äì METAS (com PREVIS√ÉO + CELEBRA√á√ÉO) *************************/
let chartMetas;
function renderMetas(data){
  const meta = data?.metaMensal ?? 0;
  const realizado = data?.realizado ?? 0;
  const periodo = data?.periodo ?? "-";

  const previsao = calcularPrevisaoMensal(periodo, realizado);

  $('#kpiMeta').textContent = CURRENCY.format(meta);
  const pReal = pct(realizado, meta);
  const pPrev = pct(previsao, meta);
  $('#kpiMetaSub').innerHTML =
    `${periodo} ‚Äî Realizado ${CURRENCY.format(realizado)} de ${CURRENCY.format(meta)} ‚Äî ` +
    `<span class="pill ${pReal>=100?'ok':pReal>=80?'neutral':'bad'}">${pReal.toFixed(1)}%</span>` +
    `<br>Previs√£o ${CURRENCY.format(previsao)} ‚Äî ` +
    `<span class="pill ${pPrev>=100?'ok':pPrev>=80?'neutral':'bad'}">${pPrev.toFixed(1)}%</span>`;

  // dispara fogos se atingiu 100%+
  if(meta>0) maybeCelebrate(pReal, state.empresa, periodo, meta, realizado);

  const ctx = document.getElementById('chartMetas');
  const ds = {
    labels:['Previsto (√∫ltima data)','Realizado (√∫ltima data)','Previs√£o (m√™s)'],
    datasets:[{
      label:'R$',
      data:[meta, realizado, previsao],
      borderWidth:2,
      backgroundColor:['#1b2652','#77e0b5','#ffb84d'],
      borderColor:'#88f0d4'
    }]
  };
  if(chartMetas){ chartMetas.data = ds; chartMetas.update(); }
  else {
    chartMetas = new Chart(ctx, {
      type:'bar',
      data: ds,
      options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } }
    });
  }
}

/********************** RENDER ‚Äì VENDAS POR DIA *************************/
let chartDia;
function renderVendasDia(data){
  const totalPeriodo = data?.totalHoje ?? 0;
  $('#kpiDia').textContent = CURRENCY.format(totalPeriodo);

  let sub = '‚Äî';
  if (data?.inicio || data?.fim) {
    const i = data.inicio ? fmtBR(data.inicio) : '‚Äî';
    const f = data.fim ? fmtBR(data.fim) : '‚Äî';
    sub = `Per√≠odo ${i} a ${f}`;
  }
  $('#kpiDiaSub').textContent = sub;

  const labels = data?.labels ?? [];
  const valores = data?.valores ?? [];
  const ctx = document.getElementById('chartDia');
  const ds = { labels, datasets:[{ label:'R$ por dia', data: valores, tension:.3, fill:true, borderWidth:2, borderColor:'#7cb8ff', backgroundColor:'rgba(124,184,255,.18)' }] };
  if(chartDia){ chartDia.data = ds; chartDia.update(); }
  else { chartDia = new Chart(ctx, { type:'line', data: ds, options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true } } } }); }
}

/********************** RENDER ‚Äì CANCELAMENTOS (pizza colorida + lista) *************************/
let chartCanc;
function renderCancelamentos(data){
  const total = data?.total ?? (Array.isArray(data?.itens) ? data.itens.reduce((s,i)=>s+parseBR(i.total??i.valor??0),0) : 0);
  $('#kpiCanc').textContent = CURRENCY.format(total);

  const totalVendas = state.data?.metas?.realizado ?? 0;
  const pc = pct(total, totalVendas);
  const subPeriodo = (data?.inicio || data?.fim) ? ` ‚Äî ${fmtBR(data.inicio||'')} a ${fmtBR(data.fim||'')}` : '';
  $('#kpiCancSub').innerHTML = `${CURRENCY.format(total)} no per√≠odo${subPeriodo} ‚Äî <span class="pill ${pc<3?'ok':pc<8?'neutral':'bad'}">${pc.toFixed(1)}%</span>`;

  // *** Pizza por ITENS (top 6). Se n√£o houver itens, cai para motivos. ***
  let labels = [], valores = [];
  if (Array.isArray(data?.itens) && data.itens.length){
    const itens = data.itens.map(it => ({ nome: it.nome||it.item||'‚Äî', total: parseBR(it.total ?? it.valor) }));
    const top = itens.sort((a,b)=>b.total-a.total).slice(0,6);
    labels = top.map(t=>t.nome);
    valores = top.map(t=>t.total);
  } else if (Array.isArray(data?.motivos)) {
    const top = [...data.motivos].sort((a,b)=>parseBR(b.valor)-parseBR(a.valor)).slice(0,6);
    labels = top.map(m=>m.motivo);
    valores = top.map(m=>parseBR(m.valor));
  }

  const ctx = document.getElementById('chartCanc');
  const ds = { 
    labels, 
    datasets:[{
      label:'R$',
      data: valores,
      borderWidth:1,
      borderColor:'rgba(255,255,255,.08)',
      backgroundColor: labels.map((_,i)=> PALETTE[i % PALETTE.length]),
      hoverOffset: 6
    }] 
  };
  if(chartCanc){ chartCanc.data = ds; chartCanc.update(); }
  else { chartCanc = new Chart(ctx, { type:'doughnut', data: ds, options:{ responsive:true, plugins:{ legend:{position:'bottom'} } } }); }

  // lista de itens ‚Äî ordenar do mais caro para o mais barato
  const tbody = document.querySelector('#tblCanc tbody');
  tbody.innerHTML='';
  const itensList = Array.isArray(data?.itens) ? data.itens.map(it => ({ nome: it.nome||it.item||'‚Äî', total: parseBR(it.total ?? it.valor) })) : [];
  itensList.sort((a,b)=>b.total-a.total);
  itensList.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>‚ùå ${it.nome}</td><td style="white-space:nowrap">${CURRENCY.format(it.total)}</td>`;
    tbody.appendChild(tr);
  });
}

/********************** RENDER ‚Äì TRAVAS (duas linhas no card + barras) *************************/
function renderTravas(data){
  // limites
  const travaTotal = parseBR(data?.travaTotal ?? data?.trava_total ?? 0);
  const travaFor   = parseBR(data?.travaCompras ?? data?.trava_compras ?? data?.travaFornec ?? 0);

  // gastos (preferir agregados; fallback: somar planosFonte9)
  let gastoGeral = parseBR(data?.gastoGeral ?? data?.totalFonte9 ?? data?.fonte9Total ?? 0);
  let gastoFor   = parseBR(data?.gastoFornec ?? data?.fornecedoresComprado ?? 0);

  if ((gastoGeral === 0 || gastoFor === 0) && Array.isArray(data?.planosFonte9)) {
    const planos = data.planosFonte9.map(p => ({ nome: String(p.nome||''), valor: parseBR(p.valor) }));
    gastoGeral = planos.reduce((s,p)=> s + Math.abs(p.valor||0), 0);
    gastoFor   = planos.filter(p => PLANOS_VALIDOS.has(p.nome)).reduce((s,p)=> s + Math.abs(p.valor||0), 0);
  }

  const pTotal = pct(gastoGeral, travaTotal);
  const pFor   = pct(gastoFor,   travaFor);
  const pill = (p)=>`<span class="pill ${p>100?'bad':p>80?'neutral':'ok'}">${p.toFixed(1)}%</span>`;

  // KPI principal (mostra 2 linhas)
  $('#kpiTrava').textContent = CURRENCY.format(gastoGeral);
  $('#kpiTravaSub').innerHTML = (travaTotal||travaFor) ? `
    Geral: <b>${CURRENCY.format(gastoGeral)}</b> de ${CURRENCY.format(travaTotal)} ‚Äî ${pill(pTotal)}<br>
    Fornecedores: <b>${CURRENCY.format(gastoFor)}</b> de ${CURRENCY.format(travaFor)} ‚Äî ${pill(pFor)}
  ` : '‚Äî';

  // barras da se√ß√£o
  const wrap = document.getElementById('travasWrap');
  wrap.innerHTML = '';
  if (travaTotal || gastoGeral || travaFor || gastoFor){
    wrap.insertAdjacentHTML('beforeend', barHTML('Trava Total de Pagamentos', gastoGeral, travaTotal));
    wrap.insertAdjacentHTML('beforeend', barHTML('Trava Fornecedores',        gastoFor,   travaFor));
  } else {
    wrap.innerHTML = '<div class="badge">Sem dados de travas para o per√≠odo.</div>';
  }
}

/********************** INICIALIZA√á√ÉO *************************/
window.addEventListener('load', ()=>{
  $('#dtInicio').value = todayISO(); $('#dtFim').value = todayISO();
});
</script>
</body>
</html>
